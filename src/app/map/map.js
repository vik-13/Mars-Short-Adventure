window.map = (() => {
  const scale = 40;
  let currentLevel = 15;
  let global = [[0,0,0,35,5],[0,38,0,62,5],[0,38,5,2,3],[0,34,7,4,1],[21,34,5,1,1],[0,0,-8,35,8],[0,38,-8,62,8],[0,-100,0,100,5],[0,-100,-8,100,8],[0,100,0,100,5],[0,100,-8,100,8],[0,-29,7,21,43],[24,-15,5,1,1],[0,-11,50,3,50],[0,-100,5,12,45],[0,-100,50,12,50],[0,200,0,100,5],[0,200,-8,100,8],[0,271,50,29,8],[0,63,5,1,3],[0,68,6,12,1],[0,83,8,1,1],[0,88,8,1,2],[0,93,8,1,3],[0,88,13,1,1],[0,83,15,1,1],[0,70,17,10,1],[0,70,21,4,1],[0,70,25,2,1],[0,70,29,1,1],[35,70,31,1,1],[10,104,5,1,1,19,0],[0,111,8,4,1],[0,132,5,6,18],[3,128,8,4,1],[3,128,12,4,1],[3,129,16,3,1],[3,130,20,2,1],[0,142,10,4,1],[0,121,23,4,1,-21,18],[0,92,40,7,1],[35,95,42,1,1],[0,160,5,1,2],[0,171,5,1,2],[1,155,4,5,1],[1,161,4,4,1],[1,166,4,5,1],[34,180,8,1,1],[3,187,8,6,1],[0,204,15,16,1,0,-11],[0,224,5,9,27],[0,200,19,4,1,16,10],[3,219,19,5,1],[3,220,23,4,1],[3,222,27,2,1],[0,206,33,6,13],[35,208,47,1,1],[0,233,8,6,1],[0,233,12,5,1],[0,233,16,3,1,0,13],[10,248,5,1,1,18,0],[11,285,5,1,1,-14,0],[3,287,8,3,1],[3,288,12,2,1],[3,289,16,1,1],[0,270,18,17,1],[0,272,19,5,1],[0,273,20,3,1],[0,274,21,1,1],[34,288,6,1,1],[33,228,32,1,1],[25,274,23,1,1],[0,284,22,6,1],[0,285,26,5,1],[0,286,29,4,1],[0,287,33,3,1],[0,288,37,2,1],[0,289,41,1,1],[32,289,45,1,1],[0,165,5,1,2],[0,154,5,1,2],[0,0,-50,100,1],[0,0,-58,100,8],[0,5,-19,19,7],[0,0,-19,5,11],[31,11,-11,1,1],[35,7,-11,1,1],[0,35,4,3,1,0,-53],[0,-55,-50,55,1],[0,24,-47,6,37],[22,25,-49,1,1],[0,49,-26,9,1],[0,61,-24,1,1],[0,65,-23,1,1],[0,69,-22,1,1],[0,73,-21,1,1],[0,76,-19,2,1],[0,81,-17,2,1],[0,86,-15,7,1],[0,87,-14,5,1],[0,88,-13,3,1],[31,89,-11,1,1],[3,45,-46,5,1],[0,52,-46,8,1],[10,52,-45,1,1,6,0],[0,62,-42,7,1],[11,62,-41,1,1,5,0],[1,51,-50,23,1],[0,74,-46,1,1],[0,79,-49,5,13],[0,100,-58,100,8],[0,89,-47,3,30],[35,90,-16,1,1],[3,87,-39,2,1],[3,84,-43,2,1],[3,87,-46,2,1],[3,87,-25,2,1],[33,107,-49,1,1],[0,92,-22,6,1],[0,102,-21,5,1],[0,116,-49,1,4],[0,144,-49,1,4],[10,121,-49,1,1,18,0],[10,126,-49,1,1,10,0],[10,132,-49,1,1,-12,0],[35,129,-47,1,1],[0,154,-47,4,39],[0,166,-49,5,37],[0,100,-50,100,1],[0,158,-46,5,1],[10,158,-45,1,1,3,0],[0,161,-42,5,1],[10,161,-41,1,1,3,0],[3,158,-38,6,1],[0,163,-35,3,1,0,10],[0,158,-21,5,1],[11,158,-20,1,1,3,0],[0,164,-18,2,1],[0,165,-14,1,1],[34,168,-11,1,1],[1,108,-21,3,1],[0,111,-20,1,1],[0,116,-19,4,1],[0,129,-18,11,1],[0,127,-19,15,1],[0,131,-17,7,1],[0,133,-16,3,1],[35,134,-14,1,1],[0,181,-47,6,39],[0,190,-49,10,2],[0,192,-47,8,4],[0,194,-43,6,4],[0,196,-39,4,4],[26,198,-34,1,1],[0,187,-36,5,1],[0,187,-32,3,1],[32,188,-30,1,1],[31,47,-44,1,1],[3,187,-20,2,1],[0,191,-18,1,1],[0,194,-15,1,1],[0,197,-12,1,1],[35,197,-10,1,1],[0,176,-19,5,1],[10,176,-18,1,1,3,0],[0,176,-31,5,1],[11,176,-30,1,1,3,0],[0,171,-14,4,1,0,-31],[0,176,-42,5,1],[11,176,-41,1,1,3,0],[34,179,-28,1,1],[0,158,-30,5,1],[10,158,-29,1,1,3,0],[0,138,7,3,1],[0,138,14,3,1],[0,142,18,3,1],[0,138,22,1,1],[0,62,-46,3,1,8,0],[0,200,-58,29,8],[0,200,-50,29,42],[0,-100,-50,45,42],[0,-100,-58,100,8],[0,5,-46,13,1],[0,20,-42,4,1],[0,9,-38,10,1],[0,20,-34,4,1],[11,5,-45,1,1,9,0],[11,16,-45,1,1,-8,0],[10,9,-37,1,1,8,0],[10,12,-37,1,1,4,0],[0,2,-30,17,1],[34,11,-28,1,1],[10,5,-29,1,1,11,0],[11,8,-29,1,1,9,0],[10,14,-29,1,1,-11,0],[33,41,-49,1,1],[35,2,-23,1,1],[0,0,-26,6,1],[1,-55,-50,55,1],[0,-5,-48,1,1],[0,-9,-46,1,1],[0,-14,-44,1,1],[0,-19,-42,1,1],[2,-26,-42,3,1],[2,-32,-42,3,1],[2,-40,-46,3,1],[2,-42,-39,4,1],[2,-53,-36,8,1],[11,-53,-35,1,1,6,0],[10,-51,-35,1,1,3,0],[0,-37,-17,16,1],[10,-36,-16,1,1,8,0],[11,-24,-16,1,1,-11,0],[11,-33,-16,1,1,10,0],[4,-45,-28,1,1,0,16],[4,-18,-11,1,1,0,-18],[0,-15,-16,1,1],[0,-11,-16,1,1],[0,-3,-12,3,1],[28,-2,-10,1,1],[3,-55,-24,8,1],[0,-55,-16,6,1],[33,-53,-15,1,1],[3,-48,-20,8,1],[4,-28,-47,1,1,0,11],[4,-34,-47,1,1,0,11],[2,-38,-42,3,1],[2,-45,-46,1,1],[2,-49,-46,1,1],[2,-55,-46,3,1],[35,-54,-43,1,1],[34,-52,-22,1,1],[4,168,6,1,1,0,12],[4,157,6,1,1,0,12],[0,-7,-16,5,1],[34,-5,-14,1,1],[0,-38,-28,3,1],[0,-32,-25,5,1],[35,-30,-21,1,1],[4,67,-27,1,1,0,10],[4,79,-24,1,1,0,12],[4,63,-26,1,1,0,5],[0,290,7,10,43],[23,294,5,1,1],[0,300,0,42,5],[0,300,-8,42,8],[0,322,5,20,45],[0,300,36,22,14],[35,304,7,1,1],[35,308,7,1,1],[35,312,7,1,1],[35,316,7,1,1],[35,320,7,1,1],[31,306,9,1,1],[31,314,9,1,1],[32,310,9,1,1],[32,318,9,1,1],[0,303,17,1,2],[0,304,15,1,2],[0,305,16,1,1],[0,306,15,1,2],[0,307,17,1,2],[0,305,17,1,1],[0,310,15,1,4],[0,313,15,1,4],[0,316,15,1,4],[0,314,17,1,1],[0,315,16,1,1],[35,310,23,1,1],[0,-25,-25,3,1],[31,-24,-21,1,1],[4,248,8,1,1,18,0],[27,-20,52,1,1],[1,-88,4,25,1],[0,-88,9,2,1],[35,-87,11,1,1],[33,-36,5,1,1],[11,-45,5,1,1,-14,0],[11,-55,5,1,1,12,0],[10,-51,5,1,1,4,0],[0,-30,9,1,1],[0,-30,14,1,1],[0,-30,19,1,1],[0,-30,24,1,1],[0,-41,22,4,1],[4,-44,19,1,1,0,7],[0,-48,22,2,1],[0,-56,22,2,1],[0,-62,22,2,1],[1,-60,22,4,1],[1,-54,22,6,1],[1,-69,22,7,1],[0,-70,22,1,1],[0,-88,25,4,1],[4,-77,41,1,1,0,6],[0,-74,44,40,1],[11,-73,45,1,1,7,0],[11,-69,45,1,1,8,0],[2,-71,49,1,1],[2,-62,49,1,1],[2,-54,49,1,1],[10,-58,45,1,1,7,0],[10,-45,45,1,1,-9,0],[11,-38,45,1,1,-4,0],[1,-74,41,45,1],[1,-77,22,7,1],[0,-80,22,3,1],[34,-87,28,1,1],[4,-75,24,1,1,18,0],[0,-88,31,1,1],[0,-88,37,1,1],[0,-88,42,1,1],[0,-84,44,4,1],[34,-25,52,1,1],[34,-15,52,1,1],[2,-83,6,1,1],[2,-77,6,1,1],[2,-70,6,1,1],[0,77,-44,2,1],[0,78,-40,1,1],[30,26,5,1,1]];
  let backward = false;

  let mapData = {
    map: [],
    enemy: [],
    doors: [],
    keys: [],
    upgrades: [],
    checkpoints: [],
    mechanics: [],
    start: new V(),
    end: new V()
  };

  function initLevel() {
    mapData = {
      map: [],
      enemy: [],
      doors: [],
      keys: [],
      upgrades: [],
      checkpoints: [],
      mechanics: [],
      start: new V(),
      end: new V()
    };
    global.forEach((item) => {
      // Blocks
      if (item[0] === 4) {
        mapData.mechanics.push(new SawBlock(
          item[0],
          item[1] * scale,
          item[2] * scale,
          item[3] * scale,
          item[4] * scale,
          (typeof item[5] !== 'undefined' ? new V(item[5], item[6]) : new V()).get().mult(scale)
        ));
      } else if (item[0] < 10) {
        mapData.map.push(new Block(
          item[0],
          item[1] * scale,
          item[2] * scale,
          item[3] * scale,
          item[4] * scale,
          (typeof item[5] !== 'undefined' ? new V(item[5], item[6]) : new V()).get().mult(scale)
        ));
      //Enemies
      } else if (item[0] === 10) {
        mapData.enemy.push(new Enemy1(item[1] * scale, item[2] * scale, (typeof item[5] !== 'undefined' ? new V(item[5], item[6]) : new V()).get().mult(scale)));
      } else if (item[0] === 11) {
        mapData.enemy.push(new Enemy2(item[1] * scale, item[2] * scale, (typeof item[5] !== 'undefined' ? new V(item[5], item[6]) : new V()).get().mult(scale)));
      } else if (item[0] >= 21 && item[0] < 25) {
        mapData.doors.push(new Door(item[0], item[1] * scale, item[2] * scale));
      } else if (item[0] >= 25 && item[0] <= 28) {
        mapData.keys.push(new Key(item[0], item[1] * scale, item[2] * scale));
      } else if (item[0] === 30) {
        mapData.start = new V(item[1] * scale, item[2] * scale);
      } else if (item[0] === 33) {
        mapData.checkpoints.push(new Checkpoint(item[1] * scale, item[2] * scale));
      } else if (item[0] < 40) {
        mapData.upgrades.push(new Upgrade(item[0], item[1] * scale, item[2] * scale));
      }
    });
  }

  return {
    i: () => {
      initLevel();
    },
    reset: () => {
      mapData.enemy.forEach((item) => {
        item.makeActive();
      });
    },
    setMap: (map) => {
      global = map;
    },
    n: () => {
      mapData.map.forEach((item) => {
        item.n();
      });

      mapData.enemy.forEach((item) => {
        item.n();
      });

      mapData.doors.forEach((item) => {
        item.n();
      });

      mapData.mechanics.forEach((item) => {
        item.n();
      });

      mapData.keys = mapData.keys.filter((key) => key.active);

      mapData.keys.forEach((key) => {
        key.n();
      });

      mapData.upgrades = mapData.upgrades.filter((upgrade) => upgrade.active);

      mapData.upgrades.forEach((upgrade) => {
        upgrade.n();
      });

      mapData.checkpoints.forEach((checkpoint) => {
        checkpoint.n();
      });
    },
    r: () => {
      mapData.map.forEach((item) => {
        item.r();
      });

      mapData.mechanics.forEach((item) => {
        item.r();
      });

      mapData.enemy.forEach((item) => {
        item.r();
      });
      mapData.doors.forEach((item) => {
        item.r();
      });
      mapData.keys.forEach((item) => {
        item.r();
      });
      mapData.upgrades.forEach((upgrade) => {
        upgrade.r();
      });
      mapData.checkpoints.forEach((checkpoint) => {
        checkpoint.r();
      });
    },
    getMap: () => mapData,
    currentLevel: () => currentLevel,
    nextLevel: (direction) => {
      backward = direction === -1;
      currentLevel += direction;
    },
    getStart: () => mapData.start,
    getCharacterStart: () => (backward ? mapData.end : mapData.start),
    isFirst: () => (currentLevel === 0),
  };
})();
